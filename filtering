window.addEventListener('load', function () {
    // 監視対象の親要素を取得
    const parentNode = document.body; // 親要素を監視

    // オプション設定
    const config = { childList: true, subtree: true };

    // コールバック関数
    const callback = function(mutationsList, observer) {
        for (let mutation of mutationsList) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(node => {
                    console.log(node);
                    if (node.nodeType === 1 && node.tagName === 'DIV') {
                        // body > div を動的に監視
                        const table = node.querySelector('table > tbody');
                        if (table) {
                            console.log('テーブルが見つかりました！');
                            runAdditionalProcess(table); // テーブルに基づいて処理を実行
                        }
                    }
                });
            }
        }
    };

    // オブザーバーインスタンスを生成
    const observer = new MutationObserver(callback);

    // 監視を開始
    observer.observe(parentNode, config);

    function runAdditionalProcess(sizeTable) {
        const typeDropdown = document.querySelector('[field-id="種類"] .kb-field-value.kb-dropdown > span');
        
        if (typeDropdown && sizeTable) {
            let selectedType = typeDropdown.textContent;
            selectedType = selectedType.split('（')[0].trim(); // '('の前を取得してトリム
            if (selectedType === "兼用帽子") {
                selectedType = "帽子";
            }
            
            // サイズリストのテーブルの行を取得
            const rows = Array.from(sizeTable.querySelectorAll('tr'));
            rows.forEach(row => {
                const spanElement = row.querySelector('td > div > div > span');
                const spanText = spanElement ? spanElement.textContent : '';
                if (spanText.includes(selectedType)) {
                    row.style.display = ''; // 表示
                } else {
                    row.style.display = 'none'; // 非表示
                }
            });
        } else {
            console.error('「種類」のドロップダウンまたはテーブルが見つかりませんでした！');
        }
    }
});
